<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
"http://www.w3.org/TR/html4/strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<title>panel</title>
		<meta name="author" content="Raffaele" />
		<meta charset="utf-8">
		<script src="../js/jsondiff.js"></script>
		<script src="../lib/jquery-1.11.3.min.js"></script>
		<script src="../lib/jquery-ui.min.js"></script>
		<link rel="stylesheet" href="../css/style.css" type="text/css" media="screen" title="no title" charset="utf-8"/>
		<link rel="stylesheet" href="../lib/jquery-ui.min.css">
		<script>
			document.addEventListener("click", clickHandler, false);
			function clickHandler(e) {
	            var e = e || window.event;
	            if (e.target.nodeName.toLowerCase() === "ul") {
	                if (e.target.getAttribute("open") === "no")
	                    e.target.setAttribute("open", "yes");
	                else
	                    e.target.setAttribute("open", "no");
	            }
	        };
		    function runEffect() {
				var selectedEffect = 'puff';
				// run the effect
				$( "#result" ).show( selectedEffect, {}, 500 ); // callback not needed
			};
			function fillDiv(diff) {
				// TODO check if it is an object or not.
				// If not thron an exception
				div = $("#diff").get(0);
				$("#diff").empty();
				// Traverse the diff object
				printSingleDiff(diff, div);
			};

			function printSingleDiff(diff, div) {
				var ul = document.createElement("ul");
				ul.setAttribute('open', 'yes');

				var singleLine = document.createElement("span");
				singleLine.setAttribute('class', 'jsonline jsondiff'+diff.status);

				var name = document.createElement("span");
				name.appendChild(document.createTextNode(diff.id));
	            name.setAttribute("class", "jsonobjname");

	            var value = document.createElement("span");
	            var textValue = (undefined !== diff.representation.original)?diff.representation.original:(undefined !== diff.representation.copy)?diff.representation.copy:'';
				value.appendChild(document.createTextNode(': '+textValue));
	            value.setAttribute("class", "jsonobjvalue");

				var changed = document.createElement("span");
            	changed.setAttribute("class", "jsonobjchanged");

	            if ("changed" === diff.status) {
	            	var arrow = document.createElement("span");
					arrow.appendChild(document.createTextNode(' => '));
		            arrow.setAttribute("class", "jsonobjvalue");

	            	var newValue = document.createElement("span");
					newValue.appendChild(document.createTextNode(diff.representation.copy));
		            newValue.setAttribute("class", "jsonobjvalue");

		            var typeSpanB = document.createElement("span");
		            typeSpanB.appendChild(document.createTextNode(' ('+diff.type+') '))
		            typeSpanB.setAttribute("class", "jsontype jsondiff"+diff.type);

	            	changed.appendChild(arrow);
	            	changed.appendChild(newValue);
	            	changed.appendChild(typeSpanB);
	            }

				var typeSpanA = document.createElement("span");
	            typeSpanA.appendChild(document.createTextNode(' ('+diff.type+') '))
	            typeSpanA.setAttribute("class", "jsontype jsondiff"+diff.type);

	            singleLine.appendChild(name);
	            singleLine.appendChild(value);
	            singleLine.appendChild(typeSpanA);
	            singleLine.appendChild(changed);
	            ul.appendChild(singleLine);

	            if (diff.type === 'object' || diff.type ==='array') {
		            for (var child in diff.values) {
		            	var li = document.createElement("li");
		            	printSingleDiff(diff.values[child], li);
		            	ul.appendChild(li);
	            	}
	            }

            	div.appendChild(ul);
			};
			$(function() {
				$( "#resizable" ).resizable();
			});
			$(function() {
			    $( "#checkdiff" ).click(function( event ) {
			        event.preventDefault();
			        var text1 = $('textarea#primary').val();
			        var text2 = $('textarea#secondary').val();

			        $('#primary').removeClass("invalidJson");
			        $('#secondary').removeClass("invalidJson");

				    origin = null;
					copy   = null;
					try{
				        origin = JSON.parse(text1);
				    }catch(e){
				    	$('#primary').addClass("invalidJson");
				    	alert('The input is not valid JSON. Please check the checkboes.');
				    }

				    try{
				        copy = JSON.parse(text2);
				    }catch(e){
				    	$('#secondary').addClass("invalidJson");
				    	alert('The input is not valid JSON. Please check the checkboes.');
				    }

					if (null == origin || null == copy) {
						return false;
					}
					var diff = jsondiff.generateDiff(origin, copy);

			        if (diff == false) {
			        	alert("Input not valid");
			        } else {
			        	fillDiv(diff);
			        	runEffect();
			        }
			    });
			});
		</script>

		<!-- Date: 2014-09-10 -->
	</head>
	<body>
		<div class='title centered darkblue'>
			<h1>JSON Diff viewver</h1>
		</div>
		<div class='description block darkblue'>
			<span>
				This add-on allows you to easily copare two JSON object. <BR/>
				It will highlight the differences.
			</span>
		</div>
		<div class='input block'>
			<div class='textarea' id="resizable" class="ui-widget-content textarea">
				<div class="divleft">
				  	<h3 class="darkblue">First version</h3>
				  	<textarea class="resizeable" id="primary">
				  	{"a":3, "c":8, "obj":{"d":6}, "obj2":{"f":6}}
				  	</textarea>
				</div>
				<div class="divright">
				  	<h3 class="darkblue">Second version</h3>
				  	<textarea class="resizeable" id="secondary">
				  		{"a":6, "b":7, "obj":{"g":5}, "obj3":{"h":3}}
				  	</textarea>
				</div>
			</div>
			<div class="centered padded">
				<a href="#" class="ui-state-default ui-corner-all button" id="checkdiff">Check diff</a>
			</div>
		</div>
		<div id='result'>
			<div class='description block darkblue'>
				<span>
					<p>*	Paste your JSON objects in the text fields. Click "Check diff" to see the diff.</p>
					<p>*	Changed values are highlited in yellow. New "arrivals" are marked in green, while removed values are highlighted in red.</p>
					<p>*	If the json string in the texbox is not valid it will be indicated.</p>
				</span>
			</div>
			<div id='diff' class='block'></div>
		</div>
	</body>
</html>	